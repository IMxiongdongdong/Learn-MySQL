# 第十九天

## `MySQL`日志

从日志当中可以查询到`MySQL`数据库的运行情况、用户操作、错误信息等，可以为`MySQL`管理和优化提供必要的信息。

### 1. 日志简介

日志主要分为四类，分别是：

* 错误日志：记录`MySQL`服务的启动、运行或停止`MySQL`服务时出现的问题。

* 查询日志：记录建立的客户端连接和执行的语句。

* 二进制日志：记录所有更改数据的语句，可以用于数据复制。

* 慢查询日志：记录所有执行时间超过`long_query_time`的所有查询或不使用索引的查询。

默认情况下，所有日志创建于`MySQL`数据目录中。通过刷新日志，可以强制`MySQL`关闭和重新打开日志文件（或在某些情况下切换到一个新的日志）。当执行一个`FLUSH LOGS`语句或执行`mysqladmin flush-logs`或`mysqladmin refresh`时，将刷新日志。

如果正使用`MySQL`复制功能，在复制服务器上可以维护更多日志文件，这种日志称为接替日志。

启动日志功能会降低`MySQL`数据库的性能。

### 2. 二进制日志

二进制日志主要记录`MySQL`数据库的变化。二进制日志以一种有效的格式，并且是事务安全的方式包含更新日志中可用的所有信息。二进制日志包含了所有更新了数据或者已经潜在更新了数据的语句。语句以”事件“的形式保存，描述数据更改。

二进制日志还包含关于每个更新数据库的语句的执行时间信息。它不包含没有修改任何数据的语句。如果想要记录所有语句，需要使用一般查询日志。使用二进制日志的主要目的是最大可能地恢复数据库，因为二进制日志包含备份后进行的所有更新。

#### 2.1 启动和设置二进制日志

默认情况下，二进制日志是关闭的，可以通过修改`MySQL`的配置文件来启动和设置二进制日志。

#### 2.2 查看二进制日志

当`MySQL`创建二进制日志文件时，首先创建一个以`filename`为名称，以`.index`为后缀的文件；再创建一个以`filename`为名称，以`.000001`为后缀的文件。当`MySQL`服务重新启动一次，以`.000001`为后缀的文件会增加一个，并且后缀名加1递增；如果日志长度超过了`max_binlog_size`的上线（默认是1GB）也会创建一个新的日志文件。

#### 2.3 删除二进制日志

`MySQL`的二进制文件可以配置自动删除，同时`MySQL`也提供了安全的手动删除二进制文件的方法；`RESET MASTER`删除所有的二进制日志文件；`PURGE MASTER LOGS`只删除部分二进制日志文件。

#### 2.4 使用二进制日志还原数据库

如果`MySQL`服务器启用了二进制日志，在数据库出现意外丢失数据时，可以使用`mysqlbinlog`工具从指定的时间点开始直到现在，或另一个指定的时间点的日志中恢复数据。

要想从二进制日志恢复数据，需要知道当前二进制日志文件的路径和文件名。一般可以从配置文件中找到路径。

#### 2.5 暂时停止二进制日志功能

修改配置文件，可以停止二进制日志，但是需要重启`MySQL`数据库。通过`SET SQL_LOG_BIN`语句可以使用`MySQL`暂停或启动二进制日志。

### 3. 错误日志

错误日志也是非常有用的，`MySQL`会将启动和停止数据库信息以及一些错误信息记录到错误日志文件中。

#### 3.1 启动和设置错误日志

在默认情况下，错误日志会记录到数据库的数据目录下。如果没有在配置文件中指定文件名，则文件名默认为`hostname.err`。错误日志的启动和停止以及日志文件名，都可以通过修改`my.ini`来配置。错误日志的配置项是`log-error`。

#### 3.2 查看错误日志

通过错误日志可以监视系统的运行状态，便于及时发现故障、修复故障。`MySQL`错误日志是以文本文件形式存储的，可以使用文本编辑器直接查看`MySQL`错误日志。如果不知道日志文件的存储路径，可以使用`SHOW VARIABLES`语句查询错误日志的存储路径。

#### 3.4 删除错误日志

从`MySQL 5.5.7`开始，`flush logs`只是重新打开日志文件，并不做日志备份和创建操作。如果日志文件不存在，`mysql`启动或执行`flush logs`时会创建新的日志文件。

在运行状态下删除错误日志文件后，`MySQL`并不会自动创建日志文件。`flush logs`在重新加载日志的时候，如果文件不存在，则会自动创建。

### 4. 通用查询日志

#### 4.1 启动和设置通用查询日志

`MySQL`服务器默认情况下并没有开启通用查询日志。如果需要通用查询日志，可以通过修改配置文件来开启。

#### 4.2 查看通用查询日志

通用查询日志中记录了用户的所有操作。通过查看通用查询日志，可以了解用户对`MySQL`进行的操作。通用查询日志是以文本文件的形式存储在文件系统中的，可以使用文本编辑器直接打开。

#### 4.3 删除通用查询日志

在用户查询、更新频繁的情况下，通用查询日志会增长的很快。数据库管理员可以定期删除比较早的通用日志。

### 5. 慢查询日志

慢查询日志是记录查询时长超过指定时间的日志。慢查询日志主要用来记录执行时间较长的查询语句。通过慢查询日志，可以找出执行时间较长、执行效率较低的语句，然后进行优化。

#### 5.1 启动和设置慢查询日志

默认是关闭的，可以通过配置文件打开。

#### 5.2 查看慢查询日志

慢查询日志是以文本形式存储的，可以直接使用文本编辑器查看。

### 5.3 删除慢查询日志

和通用查询日志一样，慢查询日志也可以直接删除。删除后在不重启服务器的情况下，需要执行`mysqladmin -u root-p flush-logs`重新生成日志文件，或者在客户端登录到服务器执行`flush logs`语句重建日志文件。