# 第十一天

## 查询函数

### 1. 基本查询语句

查询数据的基本语句为`SELECT`语句，基本格式为

~~~mysql
SELECT
	{*|<字段列表>}
	[
        FROM<表1>，<表2>...
        [WHERE<表达式>
        [GROUP BY<group by definition>]
        [HAVING <expression>[{<operator><expression>}...]]
        [ORDER BY<order by definition>]
        [LIMIT[<offset>,]<row count>]]
    ]
SELECT [字段1，字段2，...，字段n]
FROM[表或视图]
WHERE[查询条件];
~~~

`{*|<字段列表>}`包含星号通配符选字段列表，表示查询的字段，其中字段列至少包含一个字段名称，如果要查询多个字段，多个字段之间用逗号隔开，最后一个字段后不要加逗号。

`FROM<表1>，<表2>...`，表1和表2表示查询数据的来源，可以是单个或者多个。

`WHERE`子句是可选项，如果选择该项，将限定查询行必须满足的查询条件。

`GROUP BY<字段>`，该子句告诉`MySQL`如何显示查询出来的数据，并按照指定的字段分组。

`ORDER BY<字段>`，该子句告诉`MySQL`按什么样的顺序显示查询出来的数据，可以进行的排序有：升序（`ASC`），降序（`DESC`）。

`[LIMIT[<offset>,]<row count>]`，该子句告诉`MySQL`每次显示查询出来的数据条数。

### 2. 单表查询

#### 2.1 查询所有字段

**在`SELECT`语句中使用星号通配符查询所有字段。**

`SELECT`查询记录最简单的形式是从一个表中检索所有记录，实现的方法是使用星号通配符指定查找所有列的名称。语法格式如下：

`SELECT * FROM 表名;`

**在`SELECT`语句中指定所有字段。**

根据前面`SELECT`语句的格式，`SELECT`关键字后面的字段名为将要查找的数据，因此可以将表中所有字段的名称跟在`SELECT`子句后面，如果忘记了字段名称，可以使用`DESC`命令查看表的结构。有时候，由于表中的字段可能比较多，不一定能记得所有字段的名称，因此该方法会很不方便，不建议使用。

#### 2.2 查询指定字段

**查询单个字段**

查询表中的某一个字段，语法格式为：

~~~mysql
SELECT 列名 FROM 表名;
~~~

**查询多个字段**

使用`SELECT`声明，可以获取多个字段下的数据，只需要在关键字`SELECT`后面指定要查找的字段的名称，不同字段名称之间用逗号（,）隔开，最后一个字段后面不用加逗号，语法格式如下：

~~~mysql
SELECT 字段名1,字段名2,...,字段名n FROM 表名;
~~~

#### 2.3 查询指定记录

数据库中包含大量的数据，根据特殊要求，可能只需要查询表中的指定数据，即对数据进行过滤。在`SELECT`语句中，通过`WHERE`子句可以对数据进行过滤，语法格式为：

~~~mysql
SELECT 字段名1,字段名2,...,字段名n
FROM 表名
WHERE 查询条件
~~~

#### 2.4 带`IN`关键字的查询

`IN`操作符用来查询满足指定范围内的条件的记录，使用`IN`操作符，将所有检索条件用括号括起来，检索条件之间用逗号隔开，只要满足条件范围内的一个值即为匹配项。

### 2.5 带`BETWEEN AND`的范围查询

`BETWEEN AND`用来查询某个范围的值，该操作符需要两个参数，即范围的开始值和结束值，如果字段值满足指定的范围查询条件，则这些记录被返回。

#### 2.6 带`LIKE`的字符匹配查询

通配符是一种在`SQL`的`WHERE`条件子句中拥有特殊意思的字符，`SQL`语句中支持多种通配符，可以和`LIKE`一起使用的通配符有`%`和`_`。

* 百分号通配符`%`，匹配任意长度的字符，甚至包括零字符。

* 下划线通配符`_`，一次只能匹配任意一个字符。

#### 2.7 查询空值

数据表创建的时候，设计者可以指定某列中是否可以包含空值（NULL），空值不等于0，也不同于空字符串。空值一般表示数据未知、不适用或将以后添加数据。在`SELECT`语句中适用`IS NULL`子句，可以查询某字段内容为空记录。

#### 2.8 带`AND`的多条件查询

使用`SELECT`查询时，可以增加查询的限制条件，这样可以使查询的结果更加精确。`MySQL`在`WHERE`子句中使用`AND`操作符限定只有满足所有查询条件的记录才会被返回。可以使用`AND`连接两个甚至多个查询条件，多个条件表达式之间用`AND`分开。

#### 2.9 带`OR`的多条件查询

与`AND`相反，在`WHERE`声明中使用`OR`操作符，表示只需要满足其中一个条件的记录即可返回。`OR`也可以连接两个甚至多个查询条件，多个条件表达式之间用`OR`分开。

#### 2.10 查询结果不重复

在`SELECT`语句中，可以使用`DISTINCT`关键字消除重复的记录值。格式为：

~~~mysql
SELECT DISTINCT 字段名 FROM 表名;
~~~

#### 2.11 对查询结果排序

可以通过在`SELECT`语句中使用`ORDER BY`子句，对查询的结果进行排序。

* 单列排序

* 多列排序

* 指定排序方向

  默认情况下，查询数据按字母升序进行排序（从A~Z），但数据的排序并不仅限于此，还可以使用`ORDER BY`对查询结果进行降序排序（从A~Z），这可以通过关键字`DESC`实现。

#### 2.12 分组查询

分组查询是对数据按照某个或多个字段进行分组，`MySQL`中使用`GROUP BY`关键字对数据进行分组，基本语法形式为：

~~~mysql
[GROUP BY 字段][HAVING <条件表达式>]
~~~

* 创建分组

  `GROUP BY`关键字通常和集合函数一起使用

* 使用HAVING过滤分组

  `GROUP BY`可以和`HAVING`一起限定显示记录所需满足的条件，只有满足条件的分组才会被显示。

* 在`GROUP BY`子句中使用`WITH ROLLUP`

  使用`WITH ROLLUP`关键字之后，在所有查询出的分组记录之后增加一条记录，该记录计算查询出的所有记录的总和，即统计记录数量。

* 多字段分组

  使用`GROUP BY`可以对多个字段进行分组，`GROUP BY`关键字后面跟需要分组的字段，`MySQL`根据多字段的值来进行层次分组，分组层次从左到右，即先按第1个字段分组，然后再第1个字段值相同的记录中，再根据第2个字段的值进行分组，依此类推。

* `GROUP BY`和`ORDER BY`一起使用

  某些情况下需要对分组进行排序，前面`ORDER BY`用来对查询的记录排序，如果和`GROUP BY`一起使用可以完成对分组的排序。

#### 2.13 使用`LIMIT`限制查询结果的数量

`SELECT`返回所有匹配的行，有可能是表中所有的行，如仅仅需要返回第一行或者前几行，使用`LIMIT`关键字，基本语法格式如下：

~~~mysql
LIMIT [位置偏移量,] 行数
~~~

### 3. 使用集合函数查询

有时候不需要返回实际表中的数据，而只是对数据进行总结。`MySQL`提供一些查询功能，可以对获取的数据进行分析和报告，这些函数的功能有：计算数据表中记录行数的总数。

####  3.1 `COUNT()`函数

`COUNT()`函数统计数据表中包含的记录行的总数，或者根据查询结果返回列中包含的数据行数。其使用方法有两种：

#### 3.2 `SUM()`函数

是一个求和函数，返回指定列值的总和。

#### 3.3 `AVG()`函数

通过计算返回的行数和每一行数据的和，求得指定列数据的平均值。

#### 3.4 `MAX()`函数

返回指定列中的最大值。

#### 3.5 `MIN()`函数

返回查询列中的最小值。

### 4. 连接查询

连接是关系数据库模型的主要特点，连接查询是关系数据库中最主要的查询，主要包括内连接、外连接等。通过连接运算符可以实现多个表查询。在关系数据库管理系统中，表建立时各数据之间的关系不必确定，常把一个实体的所有信息存放在一个表中。当查询数据时，通过连接操作查询出存放在多个表中的不同实体的信息。当两个或多个表中存在相同意义的字段时，便可以通过这些字段对不同的表进行连接查询。

#### 4.1 内连接查询

使用比较运算符进行表间某些数据的比较操作，并列出这些表中与连接条件相匹配的数据行，组合成新的记录，也就是说，在内连接查询中，只有满足条件的记录才能出现在结果关系中。

#### 4.2 外连接查询

连接查询将查询多个表中相关联的行，内连接时，返回查询结果集合中的仅是符合查询条件和连接条件的行。但有时候需要包含没有关联的行中数据，即返回查询结果集合中的不仅包含符合连接条件的行，而且还包括左表（左外连接或左连接）、右表（右外连接或右连接）或两个边接表（全外连接）中的所有数据行。外连接分为左外连接和右外连接。

* `LEFT JOIN`（左连接）：返回包括左表中的所有记录和右表中连接字段相等的记录。

  左连接的结果包括`LEFT OUTER`子句中指定的左表的所有行，

* `RIGHT JOIN`（右连接）：返回包括右表中的所有记录和右表中连接字段相等的记录。

#### 4.3 复合条件连接查询

复合条件连接查询是在连接查询的过程中，通过添加过滤条件，限制查询的结果，使查询的结果更加准确。

### 5. 子查询

子查询指查询语句嵌套在另一个查询语句内部的查询，在`SELECT`子句中先计算子查询，子查询结果作为外层另一个查询的过滤条件，查询可以基于另一个表或者多个表。子查询中常用的操作符有`ANY(SOME)`，`ALL`，`EXISTS`。子查询可以添加到`SELECT`、`UPDATE`和`DELECT`语句中，而且可以进行多层嵌套。子查询中也可以使用比较运算符。

#### 5.1 带`ANY`、`SOME`关键字的查询

`ANY`和`SOME`关键字是同义词，表示满足其中任一条件，它们允许创建一个表达式对子查询的返回值列表进行比较，只要满足内层子查询中的任何一个比较条件，就返回一个结果作为外层查询的条件。

#### 5.2 带`ALL`关键字的子查询

`ALL`关键字与`ANY`和`SOME`不同，使用`ALL`时需要同时满足所有内层查询的条件。

#### 5.3 带`EXISTS`关键字的子查询

`EXISTS`关键字后面的参数是一个任意的子查询，系统对子查询进行运算判断它是否返回行，如果至少返回一行，那么`EXISTS`的结果为`true`，此时外层查询语句将进行查询；如果子查询没有返回任何行，那么`EXISTS`返回的结果为`false`，此时外层语句将不进行查询。

#### 5.4 带`IN`关键字的子查询

`IN`关键字进行子查询时，内层查询语句仅仅返回一个数据列，这个数据列里的值将提供给外层查询语句进行比较操作。

#### 5.5 带比较运算符的子查询

### 6. 合并查询结果

利用`UNION`关键字，可以给出多条`SELECT`语句，并将它们的结果组合成单个结果集。合并时，两个表对应的列数和数据类型必须相同。各个`SELECT`语句之间使用`UNION`或`UNION ALL`关键字分隔。`UNION`不使用关键字`ALL`，执行的时候删除重复的记录，所有返回的行都是唯一的；使用关键字`ALL`的作用是不删除重复行也不对结果进行自动排序，基本语法格式如下：

~~~mysql
SELECT column,... FROM table1
UNION[ALL]
SELECT column,... FROM table2
~~~

### 7. 为表和字段取别名

#### 7.1 为表取别名

当表名字很长或者执行一些特殊查询时，为了方便操作或者需要多次使用相同的表时，可以为表指定别名，用这个别名替代原来的名称。语法格式如下：

~~~mysql
表名 [AS] 表别名
~~~

表名为数据库中存储的数据表的名称，表别名为查询时指定的表的新名称，`AS`关键字为可选参数。

#### 7.2 为字段取别名

~~~mysql
列名 [AS] 列别名
~~~

列名为表中字段定义的名称，列别名为字段新的名称，`AS`关键字为可选参数。

### 8. 使用正则表达式查询

#### 8.1 查询以特定字符或字符开头的记录

字符`^`匹配以特定字符或者字符串开头的文本。

#### 8.2 查询以特定字符或字符串结尾的记录

字符`$`匹配以特定字符或字符串结尾的记录。

#### 8.3 用符号`.`来替代字符串中的任意一个字符

#### 8.4 使用`*`和`+`来匹配多个字符

星号匹配前的字符任意多次，包括0次。加号匹配前面的字符至少一次。

#### 8.5 匹配指定字符串

正则表达式可以匹配指定字符串，只要这个字符串在查询文本中即可，如果要匹配多个字符串，多个字符串之间使用分隔符`|`隔开。

#### 8.6 匹配指定字符中的任意一个

方括号`[]`指定一个字符集合，只匹配其中任何一个字符，即为所查找的文本。

#### 8.7 匹配指定字符以外的字符

`[^字符集合]`匹配不在指定集合中的任何字符。

#### 8.8 使用`{n}`或者`{n,m}`来指定字符串连续出现的次数

字符串`{n,}`表示至少匹配`n`次前面的字符；字符串`{n,m}`表示匹配前面的字符串不少于`n`次，不多于`m`次。